<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Chat Room</title>
</head>
<body>


    <ul id="chat-messages"></ul>
    <input id="chat-message-input" type="text" size="100"><br>
    <input id="chat-message-submit" type="button" value="Send">
    <script>
        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/comments/'
        );

        {% comment %} chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const messageList = document.querySelector('#chat-messages');
            const listItem = document.createElement('li');
            listItem.textContent = data.message;
            listItem.id = generateUniqueId();
            messageList.appendChild(listItem);
            addCommentForm(listItem);
        }; {% endcomment %}

        chatSocket.onmessage = function(e) {
          const data = JSON.parse(e.data);
          const messageList = document.querySelector('#chat-messages');
          const listItem = document.createElement('li');
          listItem.textContent = data.message;
          listItem.id = generateUniqueId();

          // Отправляем AJAX-запрос для получения информации о пользователе
          fetch(`/get_user_info/${data.user_id}/`)
              .then(response => response.json())
              .then(user => {
                  // Добавляем информацию о пользователе к комментарию
                  listItem.textContent += ` - Автор: ${user.username}`;
                  messageList.appendChild(listItem);
                  addCommentForm(listItem);
              })
              .catch(error => {
                  console.error('Ошибка при получении информации о пользователе:', error);
                  // В случае ошибки добавляем комментарий без информации о пользователе
                  messageList.appendChild(listItem);
                  addCommentForm(listItem);
              });
      };

        function generateUniqueId() {
          // Generate a timestamp to ensure uniqueness
          var timestamp = Date.now();

          // Generate a random number to add randomness
          var random = Math.random() * 1000000;

          // Combine timestamp and random number to create a unique ID
          var uniqueId = "id_" + timestamp + "_" + random;

          return uniqueId;
      }

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.key === 'Enter') {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        };

        {% comment %} // Функция для добавления сообщения в список сообщений
        function addMessage(message) {
            const messageList = document.querySelector('#chat-messages');
            const listItem = document.createElement('li');
            listItem.textContent = message;
            messageList.appendChild(listItem);
            // Добавляем кнопку "Комментировать" и форму комментария к каждому сообщению
            addCommentForm(listItem);
        } {% endcomment %}

        // Функция для добавления кнопки "Комментировать" и формы комментария к сообщению
        function addCommentForm(messageItem) {
            const commentButton = document.createElement('button');
            commentButton.textContent = 'Комментировать';
            commentButton.addEventListener('click', function() {
                const commentForm = document.createElement('form');
                commentForm.innerHTML = `
                    <input type="hidden" name="message-id" value="${messageItem.id}">
                    <input type="text" name="comment-content">
                    <button type="submit">Отправить комментарий</button>
                `;
                commentForm.addEventListener("submit", function(event) {
                  event.preventDefault(); // Prevent the default form submission behavior

                  // Your code to handle the form submission goes here

                  // For example, you can access form data using FormData
                  var formData = new FormData(event.target);

                  const ulItem = document.createElement('ul');
                  const listItem = document.createElement('li');
                  listItem.textContent = formData.get("comment-content");
                  var parentElement = document.getElementById(formData.get("message-id"));
                  // Append the child element to the parent element

                  listItem.id = generateUniqueId();
                  ulItem.appendChild(listItem);
                  parentElement.insertBefore(ulItem, commentForm);
                  // messageList.appendChild(listItem);
                  event.target.remove();
                  addCommentForm(listItem);
                  // Do something with the form data

                  // Reset the form if needed

              });
                // Удалить предыдущую форму комментария, если она есть
                const existingForm = messageItem.querySelector('form');
                if (existingForm) {
                    existingForm.remove();
                }
                messageItem.appendChild(commentForm);
            });
            messageItem.appendChild(commentButton);
        }

        // Обработчик события отправки сообщения
        document.querySelector('#chat-message-submit').addEventListener('click', function() {
            const messageInput = document.querySelector('#chat-message-input');
            const message = messageInput.value.trim();
            if (message !== '') {
                addMessage(message);
                messageInput.value = ''; // Очищаем поле ввода сообщения
            }
        });
    </script>
</body>
</html>